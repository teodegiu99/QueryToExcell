<Window
    x:Class="QueryToExcell.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:models="using:QueryToExcell.Models">

    <Grid>

        <Grid Padding="30">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Grid Grid.Row="0" Margin="0,0,0,20">
                <StackPanel>
                    <TextBlock Text="Estrazioni Database" FontSize="28" FontWeight="Bold"/>
                    <TextBlock x:Name="TxtUserInfo" FontSize="14" Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                </StackPanel>

                <Button x:Name="BtnAddQuery" 
                        Content="➕ Aggiungi Nuova Query" 
                        HorizontalAlignment="Right" 
                        VerticalAlignment="Top"
                        Style="{StaticResource AccentButtonStyle}"
                        Visibility="Collapsed" 
                        Click="BtnAddQuery_Click" />
            </Grid>

            <ListView x:Name="ListaEstrazioni" Grid.Row="1"
                      SelectionMode="None" IsItemClickEnabled="True" ItemClick="ListaEstrazioni_ItemClick">
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="Margin" Value="0,0,0,10" />
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    </Style>
                </ListView.ItemContainerStyle>
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="models:QueryInfo">
                        <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                                BorderThickness="1"
                                CornerRadius="8"
                                Padding="16"
                                HorizontalAlignment="Stretch">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <FontIcon Glyph="&#xE81E;" FontSize="24" Foreground="{ThemeResource SystemAccentColor}" Margin="0,0,16,0" VerticalAlignment="Center"/>

                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <TextBlock Text="{x:Bind Title}" FontSize="16" FontWeight="SemiBold" />
                                    <TextBlock Text="Clicca per inserire i parametri ed esportare in Excel" FontSize="12" Foreground="{ThemeResource TextFillColorSecondaryBrush}" Margin="0,4,0,0"/>
                                </StackPanel>

                                <FontIcon Grid.Column="2" Glyph="&#xE72A;" FontSize="16" Foreground="{ThemeResource TextFillColorTertiaryBrush}" VerticalAlignment="Center" Margin="0,0,10,0"/>

                                <Button Grid.Column="3"
                                        Visibility="{x:Bind PulsanteEliminaVisibile}"
                                        Tag="{x:Bind}" 
                                        Click="BtnEliminaQuery_Click"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        ToolTipService.ToolTip="Elimina questa estrazione">
                                    <FontIcon Glyph="&#xE74D;" Foreground="Red" />
                                </Button>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>

        <ContentDialog x:Name="DialogNuovaQuery" 
                       Title="Inserisci Nuova Estrazione" 
                       PrimaryButtonText="Salva Estrazione" 
                       CloseButtonText="Annulla"
                       PrimaryButtonClick="DialogNuovaQuery_PrimaryButtonClick"
                       FullSizeDesired="True">

            <ContentDialog.Resources>
                <x:Double x:Key="ContentDialogMaxWidth">4000</x:Double>
            </ContentDialog.Resources>

            <Grid Margin="0,10,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBox Grid.Row="0" x:Name="TxtTitolo" Header="Titolo Estrazione (es. Vendite)" Margin="0,0,0,15" />

                <TextBox Grid.Row="1" x:Name="TxtSql" Header="Query SQL (SENZA punto e virgola finale. Usa :Nome per Oracle)" 
                         AcceptsReturn="True" TextWrapping="NoWrap"
                         ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Auto"
                         FontFamily="Consolas" VerticalAlignment="Stretch" HorizontalAlignment="Stretch" />

                <ScrollViewer Grid.Row="2" Margin="0,15,0,0" MaxHeight="250" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="Variabili (Parametri SQL)" FontWeight="Bold"/>
                        <StackPanel x:Name="ParametersListPanel" Spacing="5" />
                        <Button Content="➕ Aggiungi Variabile" Click="BtnAddParameterRow_Click" Margin="0,10,0,0"/>

                        <Border BorderBrush="{ThemeResource SurfaceStrokeColorDefaultBrush}" BorderThickness="0,1,0,0" Margin="0,20,0,15" />
                        <TextBlock Text="Utenti Autorizzati (Solo loro potranno usare questa estrazione)" FontWeight="Bold" Margin="0,0,0,5"/>
                        <StackPanel Orientation="Horizontal" Spacing="10">
                            <TextBox x:Name="TxtNuovoUtente" PlaceholderText="es. Mario.Rossi o DOMINIO\Mario" Width="300" />
                            <Button Content="Aggiungi Utente" Click="BtnAddUtenteRow_Click" />
                        </StackPanel>
                        <StackPanel x:Name="UsersListPanel" Spacing="5" Margin="0,10,0,0" />
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </ContentDialog>

        <Grid x:Name="LoadingOverlay" Background="{ThemeResource LayerOnAcrylicFillColorDefaultBrush}" Visibility="Collapsed">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="20">
                <ProgressRing IsActive="True" Width="80" Height="80" />
                <TextBlock Text="Estrazione in corso..." FontSize="20" FontWeight="SemiBold" HorizontalAlignment="Center" />
                <TextBlock Text="L'operazione potrebbe richiedere alcuni secondi, attendere." FontSize="14" Foreground="{ThemeResource TextFillColorSecondaryBrush}" HorizontalAlignment="Center" />
            </StackPanel>
        </Grid>

    </Grid>
</Window>